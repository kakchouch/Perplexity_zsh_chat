#!/usr/bin/env zsh

# Utilisation : PERPLEXITY_API_KEY=... ./perplexity-chat.zsh
# Conversation interactive simple en TTY (sans streaming)

API_KEY="${PERPLEXITY_API_KEY}"
API_URL="https://api.perplexity.ai/chat/completions"
MODEL="sonar"   # ou "sonar-pro", "sonar-reasoning", etc.

# Couleurs via tput setaf
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
BLUE=$(tput setaf 4)
CYAN=$(tput setaf 6)
YELLOW=$(tput setaf 3)
RESET=$(tput setaf sgr0)

# dossier de sauvegarde
SAVE_DIR="$HOME/perplexity_chats"
mkdir -p "$SAVE_DIR"

#flag de sauvegarde pour sécuriser les trap
SAVE_PENDING=0

#sauvegarder à la sortie de la conversation
save_on_exit() {
	if (( SAVE_PENDING == 1 )); then 
		return
	fi

	if (( ${#chat_history} > 2 )); then #si conversation non vide
		SAVE_PENDING=1
		save_chat
	fi
	exit 0
}
trap save_on_exit INT TERM

save_chat(){
#contrôle du flag
if (( SAVE_PENDING == 0 )); then 
return 0 #skip si pas activé 
fi


local timestamp=$(date +"%Y%m%d_%H%M")
local filename="perplexity_chat_${timestamp}.md"
local filepath="$SAVE_DIR/$filename"
jq -r '
"# Conversation Perplexity

" +
(.[] |
if .role=="user" then 
"###Toi
" + .content + "

"
else 
"### IA
" + .content + "

"
end
)' <<< "$chat_history" > "$filepath"

printf "${GREEN} Sauvegardé : %s%s ${RESET}" "$filename"
echo
SAVE_PENDING=0
}


if [[ -z "$API_KEY" ]]; then
  printf "${RED}Erreur: définis PERPLEXITY_API_KEY dans ton environnement.${RESET}"
  exit 1
fi

# Historique des messages au format JSON
chat_history='[]'

jq_check=$(command -v jq)
if [[ -z "$jq_check" ]]; then
  printf "${RED}Erreur: jq est requis (sudo apt install jq).${RESET}"
  exit 1
fi

printf "Conversation Perplexity (Ctrl+C ou 'exit' pour quitter)"
echo

while true; do
  # Lecture de la question utilisateur
  print -n "${GREEN}toi>${RESET} "
  if ! read -r user_input; then
    echo
    break
  fi

  if [[ "$user_input" == "exit" ]]; then printf "Au revoir !" 
    SAVE_PENDING=1
    save_chat
    SAVE_PENDING=0
    break
  fi
 
  # Ajout du message utilisateur à l'historique
  chat_history=$(jq \
    --arg content "$user_input" \
    '. + [{"role":"user","content":$content}]' \
    <<< "$chat_history"
  )

  # Construction de la requête JSON
  payload=$(jq -n \
    --arg model "$MODEL" \
    --argjson messages "$chat_history" '
    {
      model: $model,
      messages: $messages
    }'
  )

  # Appel API
  response=$(curl -sS \
    -X POST "$API_URL" \
    -H "Authorization: Bearer $API_KEY" \
    -H "Content-Type: application/json" \
    -d "$payload"
  )

  # Gestion erreur HTTP grossière
  if [[ $? -ne 0 || -z "$response" ]]; then
    printf "%F{red}[erreur appel API]%f"
    continue
  fi

  # Extraction de la réponse assistant
  assistant_reply=$(jq -r '.choices[0].message.content // ""' <<< "$response")

  if [[ -z "$assistant_reply" || "$assistant_reply" == "null" ]]; then
    printf "${RED}[réponse vide ou invalide]${RESET}"
    printf "$response"
    continue
  fi

  # Affichage lisible en TTY
  printf "${BLUE}ia > $assistant_reply ${RESET}" | less -R
  echo 

  # Ajout de la réponse à l'historique
  chat_history=$(jq \
    --arg content "$assistant_reply" \
    '. + [{"role":"assistant","content":$content}]' \
    <<< "$chat_history"
  )
 #auto-save à la sortie
 if ((${#chat_history} > 2 )); then # si echange > 1
 #SAVE_PENDING=1
 save_chat 
 SAVE_PENDING=0
 fi
done

